{% extends 'admin.twig' %}

{% block content %}
    <h2>{{ funnel is defined ? 'Edit' : 'Create' }} Funnel</h2>
    
    <form action="{{ linkTo({'module': 'Funnels', 'action': 'save'}) }}" method="post" class="form-horizontal">
        <input type="hidden" name="idFunnel" value="{{ funnel.idfunnel|default(0) }}" />
        <input type="hidden" name="token_auth" value="{{ token_auth }}" />
        
        <div class="form-group">
            <label class="control-label col-md-2">Name</label>
            <div class="col-md-6">
                <input type="text" name="name" value="{{ funnel.name|default('') }}" class="form-control" required />
            </div>
        </div>
        
        <div class="form-group">
            <label class="control-label col-md-2">Active</label>
            <div class="col-md-6">
                 <select name="active" class="form-control">
                    <option value="1" {% if funnel.active|default(0) == 1 %}selected{% endif %}>Yes</option>
                    <option value="0" {% if funnel.active|default(0) == 0 %}selected{% endif %}>No</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Link to Goal (Optional)</label>
            <div class="col-md-6">
                 <select name="goal_id" class="form-control">
                    <option value="">-- No Goal --</option>
                    {% for goal in goals %}
                        <option value="{{ goal.idgoal }}" {% if funnel.goal_id|default('') == goal.idgoal %}selected{% endif %}>
                            {{ goal.name }} (ID: {{ goal.idgoal }})
                        </option>
                    {% endfor %}
                </select>
                <p class="help-block">If selected, this funnel will be associated with the goal. (Note: "Funnel tracking" must be enabled in Goal settings).</p>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Strict Mode</label>
            <div class="col-md-6">
                <div class="checkbox">
                    <label>
                        <input type="checkbox" name="strict_mode" value="1" {% if funnel.strict_mode|default(0) == 1 %}checked{% endif %}> Enable strict mode
                        <p class="help-block">If enabled, visitors must follow the exact path without visiting other pages between funnel steps.</p>
                    </label>
                </div>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Time Limit between Steps (seconds)</label>
            <div class="col-md-6">
                <input type="number" name="step_time_limit" value="{{ funnel.step_time_limit|default(0) }}" class="form-control" min="0" />
                <p class="help-block">Optional. If set (e.g., 60), a visitor must complete a step transition within this many seconds. Set to 0 for no limit.</p>
            </div>
        </div>

        <div class="form-group">
            <label class="control-label col-md-2">Steps Configuration</label>
            <div class="col-md-10">
                <div id="funnel-editor-app">
                    <funnel-editor :initial-steps="{{ funnel.steps|default([])|json_encode }}"></funnel-editor>
                </div>
                <!-- Fallback or noscript handling if needed -->
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save</button>
            <a href="{{ linkTo({'module': 'Funnels', 'action': 'manage'}) }}" class="btn btn-link">Cancel</a>
        </div>
    </form>
{% endblock %}
