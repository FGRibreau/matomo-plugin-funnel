{% import '@CoreHome/_dataTableActions.twig' as dataTableActions %}

{% set manageUrl = 'index.php?module=FunnelInsights&action=manage&idSite=' ~ idSite ~ '&period=' ~ period ~ '&date=' ~ date %}
{% set createUrl = 'index.php?module=FunnelInsights&action=edit&idSite=' ~ idSite ~ '&period=' ~ period ~ '&date=' ~ date %}

<style>
    .sparkline-container {
        display: inline-block;
        width: 80px;
        height: 24px;
        vertical-align: middle;
    }
    .sparkline-svg {
        width: 100%;
        height: 100%;
    }
    .sparkline-line {
        fill: none;
        stroke: #2196f3;
        stroke-width: 1.5;
    }
    .sparkline-area {
        fill: rgba(33, 150, 243, 0.1);
    }
    .sparkline-min-max {
        font-size: 9px;
        color: #999;
        margin-left: 4px;
    }
</style>

<div class="funnelOverviewWidget" data-test="funnel-overview-widget">
    <div class="funnelOverviewContent">
        {% if overviewData is not empty %}
            <div class="card">
                <div class="card-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3 class="card-title" style="margin: 0;">{{ 'FunnelInsights_ActiveFunnels'|translate }}</h3>
                        <a href="{{ manageUrl }}" class="btn btn-flat btn-small"><span class="icon-settings"></span></a>
                    </div>
                    <table class="dataTable entityTable" data-test="funnel-overview-table">
                        <thead>
                            <tr>
                                <th>{{ 'General_Name'|translate }}</th>
                                <th>{{ 'FunnelInsights_Entries'|translate }}</th>
                                <th>{{ 'FunnelInsights_Conversions'|translate }}</th>
                                <th>{{ 'FunnelInsights_ConversionRate'|translate }}</th>
                                <th>{{ 'FunnelInsights_Trend'|translate }}</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in overviewData %}
                                {% set viewUrl = 'index.php?module=FunnelInsights&action=viewFunnel&idSite=' ~ idSite ~ '&idFunnel=' ~ row.idfunnel ~ '&period=' ~ period ~ '&date=' ~ date %}
                                {% set funnelSparkline = sparklineData[row.idfunnel] is defined ? sparklineData[row.idfunnel].data : [] %}
                                <tr data-test="funnel-overview-row-{{ row.idfunnel }}">
                                    <td><a href="{{ viewUrl }}">{{ row.label|default('Funnel') }}</a></td>
                                    <td>{{ row.entries|default(0)|number_format }}</td>
                                    <td>{{ row.conversions|default(0)|number_format }}</td>
                                    <td>{{ row.conversion_rate|default(0)|number_format(1) }}%</td>
                                    <td>
                                        {% if funnelSparkline|length > 1 %}
                                            <div class="sparkline-container" data-test="sparkline-{{ row.idfunnel }}">
                                                {% set values = funnelSparkline|map(p => p.value) %}
                                                {% set minVal = min(values) %}
                                                {% set maxVal = max(values) %}
                                                {% set range = maxVal - minVal > 0 ? maxVal - minVal : 1 %}
                                                <svg class="sparkline-svg" viewBox="0 0 80 24" preserveAspectRatio="none">
                                                    {% set points = [] %}
                                                    {% for i, point in funnelSparkline %}
                                                        {% set x = (i / (funnelSparkline|length - 1)) * 80 %}
                                                        {% set y = 22 - ((point.value - minVal) / range * 20) %}
                                                        {% set points = points|merge([x ~ ',' ~ y]) %}
                                                    {% endfor %}
                                                    <polyline class="sparkline-area" points="0,24 {{ points|join(' ') }} 80,24" />
                                                    <polyline class="sparkline-line" points="{{ points|join(' ') }}" />
                                                </svg>
                                            </div>
                                            <span class="sparkline-min-max">{{ minVal|number_format(0) }}-{{ maxVal|number_format(0) }}%</span>
                                        {% else %}
                                            <span style="color: #999;">-</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        {% else %}
            <div class="notification system notification-info" style="margin-bottom: 12px;" data-test="funnel-overview-empty">
                {{ 'FunnelInsights_NoActiveFunnels'|translate }}
            </div>
            <a href="{{ createUrl }}" class="btn"><span class="icon-add"></span> {{ 'FunnelInsights_CreateFunnel'|translate }}</a>
            <a href="{{ manageUrl }}" class="btn btn-flat">{{ 'FunnelInsights_ManageFunnels'|translate }}</a>
        {% endif %}
    </div>
</div>
